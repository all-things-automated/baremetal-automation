# Ansible Role: NetBox Registration (nb_register)

[![MIT License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Ansible](https://img.shields.io/badge/ansible-2.17.14%2B-green.svg)](https://www.ansible.com/)

A comprehensive Ansible role for automated registration of bare-metal server inventory into NetBox DCIM. This role reads discovery artifacts (generated by the `discovery` role) and creates or updates corresponding NetBox resources including devices, interfaces, IP addresses, services, and inventory items.

## Overview

The `nb_register` role automates the synchronization of discovered bare-metal hardware into NetBox. It processes YAML discovery artifacts and creates a complete NetBox inventory representation including:

- Device registration with location and hardware specifications
- BMC management interfaces and IP addresses
- Network interface configurations with MAC addresses
- BMC web interface services (HTTPS)
- Storage inventory items (controllers and drives)
- Custom clickable links to BMC web interfaces

### Key Features

- **Artifact-Driven**: Processes discovery YAML artifacts automatically
- **Auto-Discovery**: Scans artifact directory for all discovery files
- **Site Extraction**: Derives NetBox site from BMC hostname prefix
- **BMC Type Detection**: Auto-detects iDRAC/iLO from FQDN and names interfaces accordingly
- **Auto-Create References**: Optionally creates missing NetBox objects (sites, manufacturers, device types, racks)
- **Flexible Configuration**: Granular control over what gets created in NetBox
- **Service Registration**: Creates HTTPS services for BMC web interfaces
- **Custom Links**: Generates clickable links to BMC consoles in NetBox UI
- **Idempotent**: Safe to run repeatedly; updates existing resources

## Requirements

### Ansible Version

- Ansible >= 2.17.14

### Collections

This role requires the following Ansible collections:

```yaml
collections:
  - netbox.netbox  # For NetBox API modules
```

Install required collections:

```bash
ansible-galaxy collection install netbox.netbox
```

### Python Dependencies

The target control node (where Ansible runs) requires:

- Python >= 3.8
- `pynetbox` Python library (for NetBox API communication)

Install Python dependencies:

```bash
pip install pynetbox
```

### NetBox Requirements

- NetBox >= 3.0
- NetBox API token with appropriate permissions (see [NetBox Setup Guide](../../../docs/NETBOX_SETUP.md))
- **No custom configuration required** - Role uses NetBox tags for lifecycle tracking (auto-created)
  
**ðŸ“– See [docs/NETBOX_SETUP.md](../../../docs/NETBOX_SETUP.md) for API token setup instructions.**

### Network Access

- Network connectivity from Ansible control node to NetBox API endpoint
- Valid NetBox API token with required permissions

## Role Variables

### Required Variables

These variables **must** be provided:

```yaml
# NetBox connection
nb_url: ""        # NetBox URL (e.g., "https://netbox.example.com")
nb_token: ""      # NetBox API token

# Device role for discovered servers
nb_default_device_role: ""  # e.g., "Server", "Compute Node", "Lab Server"
```

### Optional Variables (Defaults)

```yaml
# NetBox connection validation
nb_validate_certs: "{{ lookup('env', 'NETBOX_VALIDATE_CERTS') | default('false') | bool }}"

# Auto-create missing NetBox references (site, manufacturer, device type, rack, role)
nb_auto_create_refs: false

# Discovery artifact directory
discovery_artifact_dir: "{{ playbook_dir }}/../artifacts"

# Explicit artifact paths (if empty, scans discovery_artifact_dir)
artifact_paths: []

# NetBox site fallback (typically derived from BMC hostname)
nb_default_site: ""

# Tag configuration (auto-created in NetBox)
# Tags are applied to devices during registration for categorization and filtering
nb_tags:
  lifecycle:
    name: "Lifecycle - Discovered"
    slug: "discovered"
    color: "2196f3"  # Blue
    description: "Device discovered via BMC but not yet commissioned"
  automation:
    name: "Automation - Managed"
    slug: "automation-managed"
    color: "607d8b"  # Gray
    description: "Device managed by automation workflows"
  site:
    # Site tag is dynamically generated based on BMC name prefix
    # Valid values: US1, US2, US3, US4, DV
    color: "00bcd4"  # Cyan
    description_template: "Device located in SITE_CODE datacenter/site"

# Tags to apply during registration
nb_apply_tags:
  - lifecycle
  - automation
  - site

# Lifecycle tag replacement behavior
# If true: Always replace existing lifecycle tags with 'discovered' tag
# If false: Only apply 'discovered' tag if device has no lifecycle tags (preserves manual tagging)
nb_lifecycle_force_overwrite: false

# BMC interface and service creation
nb_create_bmc_interface: true      # Create BMC management interface
nb_create_bmc_custom_link: true    # Create clickable link to BMC web UI
nb_bmc_interface_name: "BMC"       # Fallback interface name if no -idrac/-ilo suffix

# Storage inventory creation
nb_create_storage_inventory: true  # Create inventory items for storage components

# BMC service configuration (HTTPS web interface)
nb_bmc_service_name: "HTTPS"
nb_bmc_service_protocol: "tcp"
nb_bmc_service_ports: [443]

# Custom link configuration
nb_bmc_custom_link_name: "BMC Web Interface"
nb_bmc_custom_link_weight: 100
nb_bmc_custom_link_new_window: true
```

### Recommended: Using Environment Variables

For security, provide credentials via environment variables:

```bash
export NETBOX_URL="https://netbox.example.com"
export NETBOX_TOKEN="your-api-token-here"
```

Then reference in your playbook:

```yaml
vars:
  nb_url: "{{ lookup('env', 'NETBOX_URL') }}"
  nb_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
```

### Recommended: Using Ansible Vault

For production environments, encrypt tokens:

```bash
ansible-vault create group_vars/all/vault.yml
```

Add encrypted credentials:

```yaml
vault_netbox_url: https://netbox.example.com
vault_netbox_token: your-secret-token
```

Reference in playbook:

```yaml
vars:
  nb_url: "{{ vault_netbox_url }}"
  nb_token: "{{ vault_netbox_token }}"
```

## Dependencies

This role has **no role dependencies**. It is completely self-contained.

**Complementary Role**: This role is designed to work with the `discovery` role, which generates the input artifacts.

Required Ansible collections must be installed separately (see Requirements section).

## Example Playbooks

### Basic Usage

```yaml
---
- name: Register Baremetal Hosts in NetBox
  hosts: localhost
  gather_facts: false

  vars:
    nb_url: "{{ lookup('env', 'NETBOX_URL') }}"
    nb_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    nb_auto_create_refs: true
    nb_default_device_role: "Lab Server"

  roles:
    - nb_register
```

### Advanced Usage with Custom Configuration

```yaml
---
- name: Enterprise NetBox Registration
  hosts: localhost
  gather_facts: false

  vars:
    # NetBox connection from vault
    nb_url: "{{ vault_netbox_url }}"
    nb_token: "{{ vault_netbox_token }}"
    nb_validate_certs: true
    
    # Auto-create all missing references
    nb_auto_create_refs: true
    
    # Custom artifact location
    discovery_artifact_dir: "/mnt/inventory-share/discovery"
    
    # Device configuration
    nb_default_device_role: "Compute Node"
    
    # Enable all features
    nb_create_bmc_interface: true
    nb_create_bmc_custom_link: true
    nb_create_storage_inventory: true
    
    # Custom field names (matching NetBox configuration)
    nb_cf_artifact: "discovery_source"
    nb_cf_lifecycle: "device_lifecycle"

  roles:
    - nb_register

  post_tasks:
    - name: Notify completion
      debug:
        msg: "Successfully registered {{ artifacts_to_process | length }} devices in NetBox"
```

### Selective Registration

```yaml
---
- name: Register Specific Artifacts
  hosts: localhost
  gather_facts: false

  vars:
    nb_url: "{{ lookup('env', 'NETBOX_URL') }}"
    nb_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    nb_auto_create_refs: true
    nb_default_device_role: "Server"
    
    # Register only specific artifacts
    artifact_paths:
      - "/path/to/artifacts/172.30.19.42-discovery.yml"
      - "/path/to/artifacts/172.30.19.48-discovery.yml"

  roles:
    - nb_register
```

### Minimal Configuration (Devices Only)

```yaml
---
- name: Register Devices Without Storage Inventory
  hosts: localhost
  gather_facts: false

  vars:
    nb_url: "{{ lookup('env', 'NETBOX_URL') }}"
    nb_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    nb_auto_create_refs: false  # Requires pre-existing NetBox objects
    nb_default_device_role: "Server"
    
    # Minimal configuration
    nb_create_bmc_interface: true
    nb_create_bmc_custom_link: false
    nb_create_storage_inventory: false  # Skip storage inventory items

  roles:
    - nb_register
```

### Integration with Discovery Role

```yaml
---
- name: Complete Discovery and Registration Pipeline
  hosts: localhost
  gather_facts: true

  vars:
    # BMC credentials for discovery
    discovery_bmc_username: "{{ lookup('env', 'BMC_USERNAME') }}"
    discovery_bmc_password: "{{ lookup('env', 'BMC_PASSWORD') }}"
    
    # NetBox credentials for registration
    nb_url: "{{ lookup('env', 'NETBOX_URL') }}"
    nb_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    
    # Shared artifact directory
    discovery_artifact_dir: "{{ playbook_dir }}/artifacts"
    
    # BMC targets
    bmc_targets:
      - ip: "172.30.19.42"
      - ip: "172.30.19.48"
    
    # NetBox configuration
    nb_auto_create_refs: true
    nb_default_device_role: "Lab Server"

  roles:
    - discovery      # Discover hardware
    - nb_register    # Register in NetBox
```

## NetBox Resources Created

### For Each Discovery Artifact

The role creates the following NetBox resources:

#### 1. **Device**
- **Name**: Extracted from `bmc_name` in artifact
- **Site**: Derived from hostname prefix (e.g., `us3-cab10-ru17-idrac` â†’ site `US3`)
- **Device Type**: From artifact `system_information.model`
- **Device Role**: From `nb_default_device_role` variable
- **Manufacturer**: From artifact `system_information.manufacturer`
- **Serial Number**: From artifact
- **Rack**: `Cabinet <cabinet_id>` (if present in hostname)
- **Position**: Rack unit number (if present in hostname)
- **Status**: `active`
- **Tags**: 
  - `lifecycle:discovered` (auto-created, blue colored)
  - *(Lifecycle tags are auto-created with appropriate colors; no NetBox configuration required)*
- **Custom Fields**: 
  - `discover_artifact`: Artifact filename (requires manual NetBox setup)

#### 2. **BMC Management Interface**
*(when `nb_create_bmc_interface: true`)*

- **Name**: `IDRAC` or `ILO` (auto-detected from FQDN), or `BMC` (fallback)
- **Type**: `1000base-t`
- **Management Only**: `true`
- **Description**: `IDRAC Management Interface` (or `ILO`, `BMC`)

#### 3. **BMC IP Address**
*(when `nb_create_bmc_interface: true`)*

- **Address**: BMC IP from artifact
- **DNS Name**: BMC FQDN from artifact
- **Status**: `active`
- **Assigned To**: BMC interface

#### 4. **BMC HTTPS Service**
*(when `nb_create_bmc_interface: true`)*

- **Name**: `IDRAC Web Interface` (or `ILO Web Interface`)
- **Protocol**: TCP
- **Port**: 443
- **IP Address**: BMC IP
- **Description**: HTTPS management interface

#### 5. **Network Interfaces**
For each network interface in artifact:

- **Name**: Interface ID from artifact (e.g., `NIC.Integrated.1-1-1`)
- **Type**: `25gbase-x-sfp28` (for 25G) or `1000base-t` (for 1G)
- **MAC Address**: From artifact
- **Enabled**: Based on link status (`LinkUp`/`LinkDown`)
- **Description**: From artifact

#### 6. **Storage Inventory Items**
*(when `nb_create_storage_inventory: true` and `nb_auto_create_refs: true`)*

**Storage Controllers**:
- **Name**: Controller ID
- **Manufacturer**: From artifact (auto-created if needed)
- **Part ID**: Controller model
- **Description**: Controller name

**Storage Drives**:
- **Name**: Drive ID
- **Manufacturer**: From artifact (auto-created if needed)
- **Part ID**: Drive model
- **Serial**: Drive serial number
- **Description**: `<media_type> - <capacity>GB` (e.g., `SSD - 447.13GB`)

#### 7. **Custom Link** (Global)
*(when `nb_create_bmc_custom_link: true`, created once)*

- **Name**: `BMC Web Interface`
- **Content Types**: `dcim.device`
- **Link Text**: `Open {{ object.name }} BMC`
- **Link URL**: `https://{{ object.primary_ip.address.ip }}`
- **Opens In**: New window
- **Enabled on**: All device pages

### Auto-Created References
*(when `nb_auto_create_refs: true`)*

- **Site**: Derived from BMC hostname prefix
- **Manufacturer**: System manufacturer from artifact (e.g., `Dell Inc.`)
- **Device Type**: Model from artifact (e.g., `PowerEdge R660`)
- **Device Role**: From `nb_default_device_role` variable
- **Rack**: `Cabinet <cabinet_id>` from hostname
- **Storage Manufacturers**: Unique manufacturers from storage components

## Behavior Details

### Lifecycle State Management

The role applies tags to devices for lifecycle tracking and categorization. Tags are automatically created in NetBox and are **mutually exclusive** - only one lifecycle tag exists per device at any time.

#### **Tag Categories**

1. **Lifecycle Tags** (Mutually Exclusive)
   - **discovered** (ðŸ”µ Blue) - Device discovered via BMC but not yet commissioned
   - **commissioned** (ðŸŸ  Orange) - Hardware validated, baseline policy applied, ready for OS deployment
   - **deployed** (ðŸŸ¢ Green) - Operating system installed, device in production use
   - **repurpose-ready** (âšª Grey) - Device decommissioned and sanitized, ready for rediscovery

2. **Automation Tag**
   - **automation-managed** (âš« Gray) - Device managed by automation workflows

3. **Site Tag** (Dynamic)
   - **us1**, **us2**, **us3**, **us4**, **dv** (ðŸ”µ Cyan) - Datacenter/site location (auto-generated from BMC name prefix)

#### **Lifecycle Tag Behavior**

**Mutually Exclusive**: When a device transitions between lifecycle states, the old lifecycle tag is **automatically replaced** with the new one.

**Example Transition Flow**:
```yaml
# Initial discovery
Tags: ['discovered', 'automation-managed', 'us3']

# After commissioning (commission role)
Tags: ['commissioned', 'automation-managed', 'us3']  # 'discovered' removed

# After deployment (deploy role)  
Tags: ['deployed', 'automation-managed', 'us3']  # 'commissioned' removed
```

**Protection Mode** (`nb_lifecycle_force_overwrite: false` - default):
- Discovery role will NOT overwrite manually-applied lifecycle tags
- Preserves lifecycle state when device is re-discovered
- Use case: Manual lifecycle management with automated discovery

**Force Mode** (`nb_lifecycle_force_overwrite: true`):
- Discovery role always applies 'discovered' tag, removing other lifecycle tags
- Use case: Strict automation control, no manual lifecycle changes

**ðŸ“– See [docs/LIFECYCLE_TAG_BEHAVIOR.md](../../../docs/LIFECYCLE_TAG_BEHAVIOR.md) for detailed lifecycle tag documentation.**

#### **Site Tag Generation**

Site tags are **dynamically generated** based on the BMC hostname prefix:

```yaml
# BMC hostname: us3-cab10-ru18-idrac
# Extracted site: US3
# Generated tag: name="US3", slug="us3", color="00bcd4"
```

**Valid Site Codes**: `US1`, `US2`, `US3`, `US4`, `DV`

The role validates site codes and fails with a clear error if an invalid prefix is detected.

#### **Tag Management**

**Adding New Tag Categories**:
```yaml
# 1. Add to nb_tags dictionary
nb_tags:
  lifecycle: {...}
  automation: {...}
  site: {...}
  environment:  # NEW
    name: "Production"
    slug: "production"
    color: "4caf50"
    description: "Production environment device"

# 2. Add to nb_apply_tags list
nb_apply_tags:
  - lifecycle
  - automation
  - site
  - environment  # NEW

# 3. Done! Role automatically creates and applies new tag
```

The role uses dynamic loops to process all tags in `nb_tags`, so no task changes are required when adding new categories.
    nb_lifecycle_force_overwrite: true  # Override existing tags
  roles:
    - discovery
    - nb_register
```

**NetBox UI Benefits**:
- Lifecycle tags are color-coded and visible in device list views
- Easy filtering: Click any lifecycle tag to see all devices in that state
- Visual identification: Status immediately visible without opening device details
- No custom field configuration required

### Site Detection

The role automatically extracts the NetBox site from the BMC hostname:

**Pattern**: `<site>-cab<cabinet>-ru<unit>-<bmc_type>`

**Example**:
- BMC Name: `us3-cab10-ru17-idrac`
- Extracted Site: `US3`

### BMC Type Detection

The role detects BMC type from the FQDN suffix:

| FQDN Suffix | Interface Name | Service Name |
|-------------|----------------|--------------|
| `-idrac` | `IDRAC` | `IDRAC Web Interface` |
| `-ilo` | `ILO` | `ILO Web Interface` |
| None/Other | `BMC` (fallback) | `BMC Web Interface` |

**Example**:
- FQDN: `us3-cab10-ru17-idrac.site.com`
- Interface: `IDRAC`
- Service: `IDRAC Web Interface`

### Manufacturer Handling

**When `nb_auto_create_refs: true`**:
1. Collects unique manufacturers from system, storage controllers, and drives
2. Auto-creates missing manufacturers in NetBox
3. Links inventory items to manufacturers

**When `nb_auto_create_refs: false`**:
- System manufacturer must exist (for device type)
- Storage inventory items created **without** manufacturer field
- No manufacturer auto-creation

### Idempotency

The role is fully idempotent:
- Running multiple times creates resources only once
- Updates existing resources if artifact data changes
- Custom link creation handles "already exists" errors gracefully

### Error Handling

- **Missing NetBox References** (when `nb_auto_create_refs: false`): Playbook fails with clear error message
- **Invalid Credentials**: Fails at validation step
- **Network Issues**: Fails with connection error
- **Custom Field Errors**: Provides exact field name causing issue
- **Invalid Artifacts**: Validates artifact structure before processing

### Registration Summary

At the end of each playbook run, the role displays a summary showing:

- **Racks Created**: Lists each rack (cabinet) with devices
- **Devices Registered**: FQDNs of all registered devices sorted in descending order per rack
- **Total Device Count**: Number of artifacts successfully processed

**Example Output**:
```
================================================
NetBox Registration Summary
================================================
Rack: Cabinet 10
  - us3-cab10-ru18-idrac.site.com
  - us3-cab10-ru17-idrac.site.com
================================================
Total devices: 2
```

## Troubleshooting

### Common Issues

#### 1. **"Could not resolve id of manufacturer"**

**Cause**: `nb_auto_create_refs: false` but storage component manufacturer doesn't exist in NetBox

**Solutions**:
- Set `nb_auto_create_refs: true` to auto-create manufacturers
- Pre-create manufacturers in NetBox
- Set `nb_create_storage_inventory: false` to skip storage inventory

#### 2. **"lifecycle:discovered tag not found"**

**Cause**: Tag auto-creation failed or tag format is incorrect

**Solutions**:
- Ensure you have the correct NetBox API token permissions (see API Token Permissions section)
- Verify `extras.add_tag` permission is granted to your API token
- Check NetBox logs for tag creation errors
- Tags are auto-created with format: name=`lifecycle:discovered`, slug=`lifecycle-discovered`

#### 3. **"Unknown field name in custom field data"**

**Cause**: Custom field `discover_artifact` doesn't exist in NetBox

**Solutions**:
- Create custom field in NetBox (see Requirements section)
- Update variable name to match your NetBox configuration:
  ```yaml
  nb_cf_artifact: "your_field_name"
  ```
- Omit custom field if not needed (only tags are required for lifecycle tracking)

#### 4. **"More than one result returned for site"**

**Cause**: Multiple sites with similar names exist in NetBox

**Solution**: This should not occur with the current implementation (site is derived from hostname prefix). If it does, ensure site names are unique.

#### 5. **"Invalid IP role: management"**

**Note**: This error was resolved in the current version. The `role` field is now omitted for BMC IPs.

#### 6. **No artifacts found**

**Cause**: Artifact directory is empty or path is incorrect

**Solutions**:
- Verify `discovery_artifact_dir` points to correct location
- Run the `discovery` role first to generate artifacts
- Check artifacts exist with pattern `*-discovery.yml`

### Debugging

Enable verbose output:

```bash
ansible-playbook playbooks/register.yml -vv
```

Test NetBox connectivity:

```bash
curl -H "Authorization: Token your-token" https://netbox.example.com/api/
```

Validate artifact format:

```bash
yamllint artifacts/172.30.19.42-discovery.yml
```

## Security Considerations

### Credential Management

**Never commit NetBox tokens to version control**

Use one of these methods:
1. Environment variables (recommended for CI/CD)
2. Ansible Vault (recommended for shared repos)
3. External secret management (HashiCorp Vault, AWS Secrets Manager)

### API Token Permissions

Create a dedicated NetBox service account with minimum required permissions:

```
dcim.add_device, dcim.change_device
dcim.add_interface, ipam.add_ipaddress
dcim.add_service, dcim.add_inventoryitem
dcim.add_site, dcim.add_rack (if nb_auto_create_refs: true)
dcim.add_manufacturer, dcim.add_devicetype (if nb_auto_create_refs: true)
extras.add_customlink (if nb_create_bmc_custom_link: true)
extras.add_tag (for lifecycle tag auto-creation)
```

## Performance Considerations

- **Artifact Processing**: Role processes artifacts sequentially; each artifact takes ~5-10 seconds
- **NetBox API Rate Limiting**: Respects NetBox rate limits automatically
- **Parallel Execution**: Not recommended (can cause race conditions with manufacturer creation)
- **Large Inventories**: For 100+ devices, consider batching artifacts or increasing NetBox API workers

## License

MIT

## Author Information

Part of the Bare-Metal Automation project for automated server discovery and NetBox integration.

For issues, questions, or contributions, see the project repository.
